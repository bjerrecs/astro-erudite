---
title: 'Image Management'
description: 'How we move away from manual images and started useing Packer'
date: 2025-06-18
tags: ['Citrix', 'ImageManagement', 'Packer', 'Azure']
image: './packer.png'
authors: ['sbjerre']
draft: false
---

# The motivation behind the project

For years, I managed Windows images by hand—painstaking, repetitive, and error-prone. I knew there had to be a better way, but the leap to automation always seemed just out of reach. In this post, I’ll take you through my journey from manual image management to a streamlined, automated solution using Packer and Azure. If you’ve ever felt stuck in the same rut, this guide will show you how to break free and build a modern, maintainable workflow.

**And just because I use Azure in this example, it doesn’t mean you can’t use Packer with other cloud providers or on-premise. It's just cheap and easy**

## Prerequisites

Before we dive in, let’s make sure you’re set up for success. You’ll need:

- An Azure subscription with permissions to create resources.
- Packer installed locally or on a build server.
- Basic Azure knowledge.
- Some PowerShell scripting familiarity.

If you’re ready to leave manual processes behind, let’s get started.

## Introduction
### Azure: Service Principal
We need to setup a Service Principal in Azure to allow Packer to authenticate and create resources in our Azure subscription. This is done using the Azure CLI. The Service Principal will have the necessary permissions to create and manage resources in the specified resource group.
But for this example it will have Contributor permissions on the entire subscription. 

**This is not recommended for production environments**, but it simplifies the example. In a production environment, you should limit the scope of the Service Principal to only the necessary resources.
```
az login
az ad sp create-for-rbac --role Contributor --scopes /subscriptions/aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee
```
It will generate the following Output
```
{
  "appId": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "displayName": "azure-cli-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "password": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "tenant": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
```
Remember the password (Client Secret) & appId as it will not be shown again.

### Azure: Resource group
idealy we setup two resource groups in Azure, one for  build and one for the final images. 
This allows us to keep all the build related resources in one place where we can safely delete it when dont want to keep the build artifacts around and not loose our images.
```
az group create --name CitrixAutomation --location westeurope
az group create --name CitrixAutomation-Builder --location westeurope
```
To block automation from deleting the resource group with the images, we can create a lock on the resource group. This will prevent any accidental deletion of the resource group and its resources.
```
az lock create --name LockRGDelete --lock-type CanNotDelete --resource-group CitrixAutomation
```

### 3rd Party Software
#### SOFT2go
In my professional life, I use [SOFT2Go](https://www.danofficeit.com) as the package management solution. \
This is developed in-house by Danoffice IT and is the most powerful package-tool I have come accross. \


#### Chocolatey


I decided to use [Chocolatey](https://chocolatey.org/) as the package management solution for this project. Chocolatey is a free and open-source package manager for Windows that allows you to install, update, and manage software packages easily. It has a large repository of software packages and is widely used in the Windows community.
Chocolatey allows you to create a `packages.config` file that contains the list of software packages you want to install, along with their specific versions. This file is used by Chocolatey to install the packages during the image build process.

The file is basicly an XML file that contains the list of packages you want to install. Here is an example of a `packages.config` file that includes some common software packages:

```
<?xml version="1.0" encoding="utf-8"?>
    <packages>
      <package id="googlechrome" version="137.0.7151.69" />
      <package id="vscode" version="1.100.3" packageParameters="/NoDesktopIcon" />
      <package id="visualstudiocode-disableautoupdate" version="1.0.0.20180620" />
      <package id="7zip.install" version="24.9.0"/>
    </packages>
```
You can read more on how to setuo your config file on the chocolatey website [here](https://docs.chocolatey.org/en-us/choco/commands/install/#packagesconfig).

## How-to
### Packer Template
In this section, I will share the Packer template we use to build our Citrix Master Image. This template is designed to work with Azure and includes the necessary configurations for creating a Windows-based image suitable for Citrix environments.
```
{
    "builders": [{
        "type": "azure-arm",

        "client_id": "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
        "client_secret": "---------------------------------------",
        "tenant_id": "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
        "subscription_id": "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",

        "managed_image_resource_group_name": "nnautomation",
        "managed_image_name": "CitrixMasterImage_{{isotime | clean_resource_name}}",
        "os_type": "Windows",
        "image_publisher": "MicrosoftWindowsDesktop",
        "image_offer": "Windows-10",
        "image_sku": "win10-22h2-avd-g2",

        "communicator": "winrm",
        "winrm_use_ssl": true,
        "winrm_insecure": true,
        "winrm_timeout": "5m",
        "winrm_username": "packer",

        "azure_tags": {
            "Creation": "{{isotime | clean_resource_name}}",
            "Software": "ba8b4b95-70b2-4509-bab6-e4f3ae746fa7",
            "InitiatedBy": "SBJR"
        },

        "build_resource_group_name": "CitrixAutomation-Builder",
        "vm_size": "Standard_D2ads_v6",

        "license_type": "Windows_Client",

        "shared_image_gallery_destination": {
            "subscription": "ca6495c3-6c00-4fa8-a5a6-665804dfadc5",
            "resource_group": "CitrixAutomation",
            "gallery_name": "CitrixMasterImageGallery",
            "image_name": "CitrixMasterImage",
            "image_version": "1.0.0",
            "replication_regions": [
              "westeurope",
              "northeurope"
            ]
          }

    }],
    "provisioners": [{
        "type": "powershell",
        "inline": [
            "Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))",
            "Invoke-WebRequest https://urlToChoco -OutFile packages.config",
            "choco feature enable -n allowGlobalConfirmation",
            "choco install packages.config",
            "while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
            "while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
            "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit",
            "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 10  } else { break } }"
        ]
    }]
}
```

Now its just a matter of running the Packer template with the following command:
```
packer build .\CloudDesktopA.json
```
And waiting for the image to be built. This process can take some time depending on the size of the image and the number of software packages being installed.